<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML lang="es">
<HEAD><META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
 <TITLE>LinuxFocus Noviembre 1997 Procesamiento de Correo con procmail </TITLE>
 <META name="Author" CONTENT="Miguel Angel Sepulveda">
 <META name="Keywords" CONTENT="linux magazine opengl povray photoshop gimp">
 <META name="Description" CONTENT="Free online magazine on Linux for users and developers">
 <META name="Copyright" CONTENT="&copy; 1998 LinuxFocus">
 <META name="Translator" CONTENT="">
 <META name="Date" CONTENT="1998-02-91T00:00:00Z">


</HEAD>

<BODY bgcolor="#FFFFFF"  text="#000000" link="#ff0033" vlink="#FF3333">

  <MAP name="navegator">
  <AREA shape="rect" coords="0, 0, 65, 28" alt="Hogar" href="../">
  <AREA shape="rect" coords="66, 0, 124, 28" alt="Indice" href="../indice.html">
  <AREA shape="rect" coords="125, 0, 193, 28" alt="Busqueda" href="../search.html">
  <AREA shape="rect" coords="194, 0, 260, 28" alt="Enlaces" href="../links.html">
  <AREA shape="rect" coords="261, 0, 350, 28" alt="Sobre Nosotros" href="../aboutus.html">
  </MAP>


 <TABLE border="0" width="100%" cellspacing="0" cellpadding="0">

 <THEAD>
   <TR align="center">
      <TD colspan="2"><IMG src="../../common/images/border-short.jpg" width="407" height="88"></TD>
   </TR>

   <TR align="center">
      <TD colspan="2" bgcolor="#660033"><IMG src="../../common/November1997/Navegator-bar.gif" ismap usemap="#navegator" border="0" width="351" height="28"></TD>
   </TR>

   <TR align="center">
     <TD colspan="2">     
           <TABLE  border="0" width="75%" cellspacing="0" cellpadding="5">
		<TR bgcolor="#000000">
		   <TD align="center">
               <A href="../News/index.html"><FONT face="Helvetica,Arial" color="#ffffff"><B>&nbsp; Noticias</B></FONT></A>
               <A href="../Archives/index.html"><FONT face="Helvetica,Arial" color="#ffffff"><B>&nbsp; Archivos</B></FONT></A>
               <A href="../Companies/index.html"><FONT face="Helvetica,Arial" color="#ffffff"><B>&nbsp; Compa&ntilde;ias</B></FONT></A>
               <A href="../Tips/index.html"><FONT face="Helvetica,Arial" color="#ffffff"><B>&nbsp; Consejos y Trucos &nbsp;</B></FONT></A> 
               </TD>
            </TR>
            
		<TR>
            <!--   Here goes the Title of the article, authors name and abstract -->
		   <TD align="center">
 			<FONT face="Helvetica,Arial" color="#660066"><H1>Procesamiento de Correo con procmail</H1></FONT>
 			<FONT face="Helvetica,Arial" color="#000000"><H3>por <A href="mailto:alogo@mx2.redestb.es"><FONT color="#000000">Angel Lopez</FONT></A></H3></FONT>
                  <HR size="2" noshade>
	         </TD>
            </TR>

           </TABLE>

     </TD>
   </TR>

 </THEAD>



 <TBODY>
  
 <TR>
    <TD valign="top">
          <H4><A HREF="#instalacion">Instalaci&oacute;n</A></H4>
          <H4><A HREF="#funcionamiento">Funciones B&aacute;sicas</A></H4>
          <H4><A HREF="#configuracion">Configuraciones</A></H4>
          <H4><A HREF="#lists">Listas de Correo</A></H4>
          <H4><A HREF="#contestacion">Respondiendo Correo</A></H4>
          <H4><A HREF="#evitando">Bucles Infinitos </A></H4>
          <H4><A HREF="#decode">Descifrando Mensajes</A></H4>
          <H4><A HREF="#conclusion">Conclusiones</A></H4>
    </TD>
   
    <TD align="center">
       <TABLE border="0" width="80%" cellspacing="0" cellpadding="0">
	  <TR>
          <TD>

	   <A NAME="instalacion"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Instalaci&oacute;n</H3></FONT> 

           <P>El primer paso es conseguir la <a href="ftp://ftp.informatik.rwth-aachen.de/pub/packages/procmail/procmail.tar.gz">última versión de
           procmail</a>. Cuando se comenzó a escribir este artículo la última versión
           disponible era la 3.11pre7.</P>

           <P>Una vez que hayas obtenido el fichero con las fuentes del programa, para
           instalarlo deberás descomprimirlo con el siguiente 
           comando: <tt>tar -xzvf procmail.tar.gz</tt></P>



           <P>El siguiente paso sería editar los ficheros <tt>Makefile</tt> y

           <tt>config.h</tt>. Al ser este artículo de introducción y para no complicar

           en exceso este primer acercamiento a procmail, no trataremos las diferentes 

           opciones de configuración de estos ficheros. El lector interesado en ello 

           puede consultar las páginas de manual y la documentación suministrada con el

           paquete. </P>



           <P>No obstante, es conveniente resaltar la presencia de la opción <tt>BASENAME</tt>

           en el fichero <tt>Makefile</tt>. Con esta opción indicaremos el directorio

           base donde se instalará procmail. Del directorio que indiquemos en esta

           opción colgarán otros como <tt>bin</tt> y <tt>man</tt>.</P>



           <P>Finalmente, para compilar el paquete, deberemos ejecutar el comando <tt>make

           install</tt>.</P>



           <P>Procmail puede instalarse para todo el sistema y ser llamado desde alguna

           regla del <tt>sendmail(8)</tt> o puede ser instalado por un usuario para su uso

           particular. En éste último caso, el usuario indicará el uso de procmail en

           su <tt>.forward</tt>, donde habrá una línea como la siguiente:</P>



           <tt>|IFS=' ' && exec /home/juan/procmail/bin/procmail -f- || exit 75 #juan</tt>



           <P>He indicado esta línea suponiendo que el usuario <i>juan</i> ha instalado procmail 

           en su HOME. Para esta línea en particular deberiamos haber indicado como

           <tt>BASENAME</tt> el directorio <tt>/home/juan/procmail</tt>.</P>



	   <A NAME="funcionamiento"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Funcionamiento B&aacute;sico</H3></FONT> 



           <P>Procmail lee de su entrada standard un mensaje. Consulta el fichero

           <tt>.procmailrc</tt> que es un fichero de configuración que el usuario

           deberá tener en su HOME. Este fichero define ciertas reglas que servirán

           para que el procmail sepa qué hacer con el mensaje que ha leido.</P>



           <P>Se podrá indicar que compruebe la cabecera del mensaje y busque ciertas

           cadenas en ella, para decidir si queremos guardar el mensaje, descartarlo,

           contestarlo automáticamente, etc...</P>



           <P>Procmail nos permitirá tratar el correo que nos llegue, o el almacenado en

           un fichero, de manera automática.</P>


	   <A NAME="configuracion"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Configuraci&oacute;n</H3></FONT> 




           <P>El fichero de configuración usado es <tt>.procmailrc</tt> y deberemos

           tenerlo en nuestro HOME.</P>



           <P>Toda línea que comience por <tt>#</tt> se considerará un comentario.</P>



           <P>Las líneas que comiencen por <tt>:0</tt> o <tt>:0:</tt> indicarán el

           comienzo de una regla que indicará a procmail qué debe hacer con un mensaje.</P>



           <P>Las líneas que comienzan por <tt>*</tt> indican la condición de una regla.

           De esta manera procmail selecciona la regla que debe aplicar a un mensaje

           determinado.</P>



           <P>Las restantes líneas, es decir, aquellas que no comienzan por un <tt>:</tt>,

           un <tt>#</tt> o un <tt>*</tt> se considerarán comandos, es decir, lo que

           tiene que hacer procmail al ver que cierto mensaje cumple la condición

           indicada en una regla. Se podrá borrar el mensaje, redirigirselo a otra

           persona, guardarlo en un fichero...</P>



           <P>Lo primero que deberás indicar en tu <tt>.procmailrc</tt> son algunas

           variables de entorno, a continuación te muestro algunas que es recomendable

           establecer:</P>



           <P><B>MAILDIR</B><BR>

           Indica el directorio donde se almacenan los ficheros con los mensajes de

           correo. Generalmente apuntará a $HOME/mail o $HOME/Mail. El que sea uno u

           otro, o incluso otro nombre de directorio dependerá del lector de correo que

           usemos.</P>



           <P><B>LOGFILE</B><BR>

           Indica un fichero donde procmail dejará constancia de todo lo que vaya

           haciendo.</P>



           <P><B>SENDMAIL</B><BR>

           Indica dónde encontrar el sendmail, que se usará cuando se conteste

           automáticamente a los mensajes.</P>



           <P><B>FORMAIL</B><BR>

           Indica dónde encontrar el formail. Este programa se distribuye junto al

           procmail y sirve para modificar las cabeceras de los mensajes o reformatear

           un mensaje antes de enviarlos o almacenarlos.</P>



           <P><B>DEFAULT</B><BR>

           Fichero donde se almacenará un mensaje si no se le ha podido aplicar ninguna

           de las reglas definidas.</P>



           <P>En cualquier parte de <tt>.procmailrc</tt> se puede redifinir una variable

           de entorno. Si se indicase sin el <tt>=</tt> y un valor, dicha variable se

           eliminaría.</P>



           <P>Respecto a las reglas, apuntar que podemos clasificarlas en dos tipos:

           reglas que dan por entregado un mensaje y las que no lo dan por

           entregado. </P>



           <P>Las primeras suponen que el mensaje ya ha sido entregado tras la

           ejecución de la regla, por lo que no se siguen buscando más reglas que

           pudieran aplicarse al mensaje.</P>



           <P>En el segundo caso no se da por entregado el mensaje, así que al terminar

           la ejecución de la regla actual se continúa la búsqueda de otra regla que

           pudiera ser aplicada.</P>



           <P>La sintaxis general de una regla es la siguiente:<BR>



	   <PRE>

           :0 [opciones] [ : [fichero de exclusión] ]

           * condicion 1

           * condicion 2

                 .

                 .

                 .

           * condición N

           comando

           </PRE>



           <P>Vayamos por partes analizando esta construcción.

           En primer lugar cada regla comienza por un <tt>:0</tt>, a continuación

           podemos indicar las siguientes opciones:</P>



           <b>H</b> La condición se aplica a la cabecera del mensaje.<BR>

           <b>B</b> La condición se busca en el cuerpo del mensaje.<BR>

           <b>D</b> Al analizar la condición se distingue entre mayúsculas y minúsculas.<BR>

           <b>A</b> Esta regla se ejecutará únicamente si su antecesora lo hizo.<BR>

           <b>a</b> Igual que la anterior, con la salvedad de que la ejecución de la

                    regla anterior debió realizarse sin errores.<BR>

           <b>E</b> Esta regla se ejecutará si la anterior no lo hizo.<BR>

           <b>e</b> Esta regla se ejecutará si se intento ejecutar la regla anterior

                    pero hubo algún error.<BR>

           <b>h</b> La cabecera se pasa al comando.<BR>

           <b>b</b> El cuerpo del mensaje se pasa al comando.<BR>

           <b>f</b> El comando se considerará como un filtro.<BR>

           <b>c</b> Genera un <i>carbon copy</i> del mensaje. Al ejecutar una regla que

                    da el mensaje por entregado con este flag, se consigue que el mensaje no se

                    de por entregado y se puedan ejecutar otras reglas a continuación de esta.<BR>

           <b>w</b> Espera a que el comando se ejecute para recibir su código de

                    salida.<BR>

           <b>W</b> Igual que el anterior pero en caso de error no emite ningún

                    mensaje.<BR>



           <b>i</b> Ignora los posibles errores de escritura.<BR>

           <b>r</b> Escribe el mensaje tal y como esté. No comprueba que termine en

                    una línea en blanco que sería lo correcto.<BR>



           <P>Por defecto, de no indicarse nada, se comparará la condición de la regla con

           la cabecera del mensaje (opción H). Al comando se le pasará a su entrada

           estándard tanto la cabecera del mensaje como su cuerpo (opciones h y b). No

           se hará distinción entre mayúsculas y minúsculas.</P>



           <P>Tras el <tt>:0</tt> y las posibles opciones puede aparecer opcionalmente un

           segundo <tt>:</tt>, de hacerlo se estará indicando que el fichero destino

           donde se escriba el mensaje debe bloquearse para que dos procesos no

           escriban a la vez sobre el fichero. Opcionalmente se puede indicar el

           fichero de exclusión que se usará para realizar el bloqueo.</P>



           <P>A continuación vienen las condiciones, una por línea y precedidas por un

           <tt>*</tt>. En las condiciones generalmente se usan <i>expresiones regulares</i>

           para intentar encontrar cadenas de texto dentro de la cabecera o del cuerpo del

           mensaje. Las expresiones regulares usan los siguientes símbolos entre otros:</P>



           <b>^</b> Comienzo de la línea.<BR>

           <b>$</b> Final de la línea.<BR>

           <b>.</b> Cualquier caracter excepto un salto de línea.<BR>

           <b>*</b> Cero o más veces.<BR>

           <b>+</b> Una o más veces.<BR>

           <b>?</b> Cero o una vez.<BR>

           <b>[a-z]</b> Rango de caracteres, en este caso de la 'a' a la 'z'.<BR>

           <b>[^a-z]</b> Cualquier caracter que no esté en el rango de la 'a' a la 'z'.<BR>

           <b>a|b</b> La 'a' o la 'b'<BR>

 

           <P>Tras las condiciones viene un único comando. Si el primer carácter del

           comando es alguno de los siguientes se sigue un comportamiento especial:</P>



           <b>!</b> Se redirige el mensaje a todas las direcciones de correo que se

           indiquen.<BR>



           <b>|</b> Si después del símbolo se pone el nombre de un programa,

           éste se ejecutará. Si no se indica nada tras el símbolo, el mensaje se

           sacará por la salida estándard. Si se indica el nombre de una variable de

           entorno antes del <b>|</b>, entonces el resultado del comando indicado se

           guarda en esta variable.<BR>




	   <A NAME="lists"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Mailing Lists</H3></FONT> 







           <P>Una situación en la que procmail puede sernos útil es en la organización del

           correo. Supongamos que estamos apuntados a 3 listas de distribución de

           Linux. Cada lista se identifica por la dirección desde la cual nos llegan

           sus respectivos mensajes, así pues podríamos tener las siguientes

           direcciones:</P>



	   <PRE>

           l-linux@calvo.teleco.ulpgc.es

           linux@nuclecu.unam.mx

           linux-security@redhat.com

           </PRE>

 

           <P>En condiciones normales los mensajes de estas listas nos llegarían juntos, y

           de no separarlos los tendríamos todos mezclados en nuestro fichero de

           correo. Sería mucho más cómodo si al llegar se fuesen clasificando y

           guardando en diferentes ficheros.</P>



           <P>Procmail nos puede solucionar este caso de manera sencilla. Podríamos usar

           un fichero <tt>.procmailrc</tt> que tuviese las siguientes reglas para

           solucionar nuestro ejemplo de las mailing lists de Linux:</P>



<PRE>

:0

* ^From.*l-linux@calvo.teleco.ulpgc.es

l-linux



:0

* ^From.*linux@nuclecu.unam.mx

linux-mx



:0

* ^From.*linux-security@redhat.com

linux-security

</PRE>





           <P>Veamos detenidamente una de las reglas. Si comprendes el funcionamiento de

           ésta, comprenderás el resto ya que la idea es la misma siempre.</P>



           <P>En primer lugar nos encontramos un <tt>:0</tt> que nos indica el comienzo de

           una regla. No aparece ninguna opción adicional así que se toman las opciones

           por defecto: no se diferencian mayúsculas y minúsculas, la condición se

           aplica sobre la cabecera del mensaje, al comando se le pasará tanto la

           cabecera del mensaje como su cuerpo.</P>



           <P>En la siguiente línea encontramos la condición, que como ya hemos visto

           siempre se identifica porque el primer carácter de la línea es un

           <tt>*</tt>. La condición es la siguiente expresión regular: </P>



           <tt>^From.*linux@nuclecu.unam.mx</tt><BR>



           <P>El <tt>^From</tt> indica que se buscarán aquellas líneas que 

           comiencen por <tt>From</tt></P>



           <P>El <tt>.*</tt> que sigue, quiere decir cualquier número de caracteres. Ya

           hemos visto que en expresiones regulares <tt>.</tt> equivale a cualquier

           carácter y <tt>*</tt> hace referencia a 0 o más caracteres. Por tanto con

           <tt>.*</tt> indicamos que tras el <tt>From</tt> inicial pueden venir 0 o más

           caracteres.</P>



           <P>A continuación deberá venir <tt>linux@nuclecu.unam.mx</tt> que es la

           dirección desde la cual provienen los mensajes.</P>



           <P>Si piensas un poco en la expresión regular, verás que lineas como las

           siguientes serían reconocidas:</P>



<PRE>

From: linux@nuclecu.unam.mx

From:linux@nuclecu.unam.mx

FROM linux@nuclecu.unam.mx

</PRE>





           <P>Ya podemos distinguir los mensajes que provengan de esta dirección del

           resto. Y ahora que ya tenemos un mensaje, ¿qué hacemos con él?</P>



           <P>La siguiente línea es el comando, y nos indicará qué hacer con el mensaje

           reconocido. En nuestro caso indicamos un nombre de fichero <tt>linux-mx</tt>

           donde queremos que se guarde el mensaje. El nombre de fichero, de no

           indicarse un camino absoluto, se tomará como relativo al directorio indicado

           en la variable de entorno <tt>$MAILDIR</tt>.</P>



           <P>Como ves, de esta manera podemos guardar en diferentes ficheros los mensajes

           que nos lleguen de diferentes listas de distribución, diferenciándolos por

           su dirección de origen (From).</P>



	   <A NAME="contestacion"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Contestaci&oacute;n Autom&aacute;tica</H3></FONT> 



           <P>Otra situación en la que procmail puede ser de ayuda es en las

           contestaciones automáticas. Puede serte útil, por ejemplo, si quieres mandar

           automáticamente tu llave pública de PGP a todas aquellas personas que te lo

           soliciten por E-Mail.</P>



           <P>Para ello, tomamos como regla que cualquier mensaje que tenga la cadena

           "PGP" en el campo de <i>Subject</i> será una petición de envío de nuestra

            llave pública de PGP. La regla podría definirse de la siguiente

           manera:</P>

<PRE>

0:

* ^Subject.*PGP

| (formail -r ; cat $HOME/llave.asc) | sendmail -t

</PRE>



            <P>Esta misma idea se puede aplicar para hacer el típico programa que avisa a la

            gente de que nos hemos ido de vacaciones y que por tanto contestaremos su

            E-Mail a la vuelta:</P>



<PRE>

0:

| (formail -r; cat $HOME/vacaciones.txt) | sendmail -t

</PRE>



            <P>En este caso no hay condición, ya que se quiere aplicar a todos los mensajes

            que nos lleguen.</P>



	   <A NAME="evitando"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Evitando Bucles en
           Contestaciones Autom&aacute;ticas</H3></FONT> 






           <P>En los ejemplos expuestos no nos hemos preocupado de manejar los posibles

           bucles que se puedan producir con el correo cuando se realizan

           contestaciones automáticas. </P>



           <P>Si nos llegase un mensaje cuyo origen fuese nuestra propia dirección de E-Mail, 

           el programa contestaría a esa dirección, llegándonos dicha contestación a

           nosotros mismos. Este mensaje volvería a ser contestado, y así sucesivamente

           entrando en un bucle infinito. Para evitarlo, cuando contestamos al mensaje 

           añadimos una nueva línea a la cabecera para indicar que ya lo hemos

           contestado. Esto lo hacemos con la opción <tt>-A</tt> de formail:</P>



  

           <TT>formail -r -A"X-Loop: dir@email.es" </TT><BR>



           <P>Donde <tt>dir@email.es</tt> sería tu propia dirección de E-Mail. De esta manera 

           al crear la cabecera para responder a un mensaje se le añade la línea

           <i>X-Loop</i> que comprobaremos luego en nuestras reglas de la siguiente

           manera:</P>



<PRE>

:0

* !^X-Loop: dir@email.es

| (formail -r -A"X-Loop: dir@email.es" ; 

    cat $HOME/vacaciones.txt) | sendmail -t

</PRE>



            <P>Con esta regla evitamos entrar en un bucle, ya que los mensajes que

            contengan en la cabecera la línea <i>X-Loop</i> no cumplirían la condición y

            no serían contestados.</P>



	   <A NAME="decode"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Decodificando Ficheros</H3></FONT> 






           <P>Otra regla interesante para nuestro <tt>.procmailrc</tt> podría ser aquella

           que decodificase automáticamente aquellos mensajes que contengan un fichero

           codificado con <tt>uuencode(1)</tt>. La regla podría ser la 

           siguiente:</P>



<PRE>

:0 B

* ^begin 644 .*

{

	MAILDIR=$HOME/ficheros

	

	:0

	| uudecode

}

</PRE>





            <P>En esta regla indicamos explícitamente con la opción <tt>B</tt> que

            únicamente deseamos comprobar la condición en el cuerpo del mensaje. </P>



            <P>Si encontramos una línea que comience con la cadena "begin 644" significa 

            que hemos encontrado el comienzo de un fichero codificado con

            <tt>uuencode(1)</tt> así que establecemos la variable de entorno

            <tt>MAILDIR</tt>, que sería equivalente a cambiar al directorio indicado en

            dicha variable, ya que todas las escrituras se realizarán tomando como

            directorio base el indicado. En nuestro caso nos interesa guardar los

            ficheros recibidos por E-Mail en <tt>$HOME/ficheros</tt>.</P>



            <P>A continuación tenemos una regla, sin condición, que únicamente pasa el

            mensaje al <tt>uudecode(1)</tt> para que lo decodifique. El fichero original

            lo obtendremos en <tt>$HOME/ficheros</tt>.</P>





	   <A NAME="conclusion"></A> 
           <FONT  face="Helvetica,Arial" color="#660033"><H3>Conclusi&oacute;n</H3></FONT> 






           <P>Como se puede apreciar de la breve introducción que se ha realizado a

           procmail, este programa puede ser realmente versátil y ayudarnos en la

           gestión del correo de una manera fácil y cómoda. Recomiendo experimentar con

           las expresiones regulares y las reglas, para adaptar el programa a tus

           necesidades, ya que sus posibilidades van mucho más allá de lo que se ha

           expuesto en esta pequeña introducción.</P>








          </TD>
        </TR>
	 </TABLE>

     <HR size=2 noshade>

    </TD>

 </TR>

 </TBODY>

<TBODY>
  <TR>
    <TD colspan="2">
    <B>Para m&aacute;s informaci&oacute;n</B>:<BR>
    <UL>
      <LI>Consulte la p&aacute;gina de manual del procmail</LI>
      <LI>Lea otros art&iacute;culos por el mismo autor:<A href="article7.html">PGP en Linux</A>.</LI> 
     <UL><BR><BR>
    <TD>
  </TR>
</TBODY>

 <TR bgcolor="#660033">
   <TD colspan="2" align="center"><FONT face="Helvetica,Arial" color="#FFFFFF"><B>
         &copy; 1998 Angel Lopez</B></FONT><BR>
    <FONT color="#ffffff">This website is mantained by 
    <A href="mailto:angel@mercury.chem.pitt.edu"><FONT color="#ffffff">Miguel A Sepulveda</FONT></A></FONT>.
   </TD>
 </TR>



</TABLE>


</BODY>
</HTML>






