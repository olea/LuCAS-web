<HTML
><HEAD
><TITLE
>Configurando Contabilidad IP</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.76b+
"><LINK
REL="HOME"
TITLE="Guía de Administración de Redes con Linux"
HREF="index.html"><LINK
REL="UP"
TITLE="Contabilidad IP"
HREF="x-087-2-accounting.html"><LINK
REL="PREVIOUS"
TITLE="Configurando el núcleo para contabilidad IP"
HREF="x-087-2-accounting.kernel.config.html"><LINK
REL="NEXT"
TITLE="Utilizando los resultados de contabilidad IP"
HREF="x-087-2-accounting.viewing.results.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="publicacoes.css"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Guía de Administración de Redes con Linux</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x-087-2-accounting.kernel.config.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Capítulo 10. Contabilidad IP</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="x-087-2-accounting.viewing.results.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="X-087-2-ACCOUNTING.IPFWADM">10.2. Configurando Contabilidad IP</H1
><P
>&#13;



Debido a que la contabilidad IP se relaciona estrechamente con el cortafuegos de IP,
la misma herramienta fue designada para configurarla, de modo que <B
CLASS="COMMAND"
>ipfwadm</B
>,
<B
CLASS="COMMAND"
>ipchains</B
> o <B
CLASS="COMMAND"
>iptables</B
> sean utilizados para configurar la
contabilidad IP. La sintaxis de órdenes es muy similar a la de las reglas del cortafuegos,
así que no nos centraremos en eso, pero discutiremos qué puede descubrir sobre la naturaleza
de su tráfico de red utilizando esta característica.</P
><P
>La sintaxis general para contabilidad IP con <B
CLASS="COMMAND"
>ipfwadm</B
> es:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A [<TT
CLASS="REPLACEABLE"
><I
>sentido</I
></TT
>] [<TT
CLASS="REPLACEABLE"
><I
>orden</I
></TT
>] [<TT
CLASS="REPLACEABLE"
><I
>parámetros</I
></TT
>]</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>El argumento sentido es nuevo. Esto se codifica simplemente como
<TT
CLASS="LITERAL"
>entrada (in)</TT
>,
<TT
CLASS="LITERAL"
>salida (out)</TT
>, o
<TT
CLASS="LITERAL"
>ambos (both)</TT
>.
Estas trayectorías son desde la perspectiva de la propia máquina GNU/Linux.
<TT
CLASS="LITERAL"
>entrada (in)</TT
> se refiere a datos que entran a
la máquina desde una conexión de red y <TT
CLASS="LITERAL"
>salida (out)</TT
>
se refiere a datos que están transmitiéndose por este nodo en una conexión de red.
El sentido <TT
CLASS="LITERAL"
>ambos (both)</TT
> es la suma de ambas trayectorias,
entrante y saliente.</P
><P
>La sintaxis general para la orden <B
CLASS="COMMAND"
>ipchains</B
> 
e <B
CLASS="COMMAND"
>iptables</B
> es:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A <TT
CLASS="REPLACEABLE"
><I
>cadena </I
></TT
><TT
CLASS="REPLACEABLE"
><I
>especificación-de-regla</I
></TT
></B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A <TT
CLASS="REPLACEABLE"
><I
>cadena </I
></TT
><TT
CLASS="REPLACEABLE"
><I
>especificación-de-regla</I
></TT
></B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>Las órdenes <B
CLASS="COMMAND"
>ipchains</B
> e <B
CLASS="COMMAND"
>iptables</B
>
permiten especificar el sentido de una manera más consistente con las
reglas de cortafuegos.  El cortafuegos de cadenas IP<A
NAME="AEN9409"
HREF="#FTN.AEN9409"
>[1]</A
> no le permite
configurar una regla que agrege ambos sentidos, pero permite configurar
reglas en la cadena <TT
CLASS="LITERAL"
>forward</TT
> que la antigua implementación
no hacía. Veremos la diferencia que produce, en algunos ejemplos un poco
mas adelante.</P
><P
>Las órdenes son bastante iguales a las reglas de cortafuegos, excepto que
las políticas de reglas no se aplican aquí. Podemos agregar, insertar,
eliminar y listar las reglas de contabilidad. En el caso de
<B
CLASS="COMMAND"
>ipchains</B
> e <B
CLASS="COMMAND"
>iptables</B
>, todas las 
reglas válidas son reglas de contabilidad, y cualquier orden que no
especifica la opción <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>-j</I
></SPAN
> sólo realiza recuento.</P
><P
>Las reglas de especificación de parámetros para contabilidad IP son las mismas
que aquellas usadas para cortafuegos IP. Éstas son las que nosotros usamos
para definir precisamente qué tráfico de la red deseamos contabilizar y sumar.</P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="X-087-2-ACCOUNTING.BY.ADDRESS">10.2.1. Contabilidad por Dirección</H2
><P
>&#13;Trabajemos con un ejemplo para ilustrar como usaríamos la contabilidad IP.</P
><P
>Imagine que tenemos un encaminador basado en Linux que sirve a dos departamentos
en la Cervecería Virtual. El encaminador tiene dos dispositivos Ethernet,
<TT
CLASS="FILENAME"
>eth0</TT
> y <TT
CLASS="FILENAME"
>eth1</TT
>, cada uno de los cuales
sirve a un departamento; y un dispositivo PPP, <TT
CLASS="FILENAME"
>ppp0</TT
>, que
nos conecta vía un enlace serie de alta velocidad al campus principal de la
Universidad Groucho Marx.</P
><P
>También imaginemos que para propósitos de faturación queremos conocer el total
de tráfico generado por cada uno de los departamentos a lo largo del enlace serie,
y para propósitos de administración queremos conocer el total de tráfico generado
entre los dos departamentos.</P
><P
>La siguiente tabla muestra las interfaces y direcciones que usaremos en nuestro
ejemplo:</P
><P
><DIV
CLASS="INFORMALTABLE"
><A
NAME="AEN9430"><P
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><THEAD
><TR
><TH
ALIGN="LEFT"
VALIGN="TOP"
>interfaz</TH
><TH
ALIGN="LEFT"
VALIGN="TOP"
>dirección</TH
><TH
ALIGN="LEFT"
VALIGN="TOP"
>máscara de red</TH
></TR
></THEAD
><TBODY
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
>eth0</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
>172.16.3.0</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
>255.255.255.0</TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
>eth1</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
>172.16.4.0</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
>255.255.255.0</TD
></TR
></TBODY
></TABLE
><P
></P
></DIV
></P
><P
>Para responder a la pregunta, &ldquo;¿ Cuántos datos genera cada
departamento en el enlace PPP ?&rdquo;, podríamos usar una regla 
parecida a:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -S 172.16.3.0/24 -b</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -S 172.16.4.0/24 -b</B
></TT
></PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A input -i ppp0 -d 172.16.3.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A output -i ppp0 -s 172.16.3.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A input -i ppp0 -d 172.16.4.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A output -i ppp0 -s 172.16.4.0/24</B
></TT
></PRE
></TD
></TR
></TABLE
>

y con <B
CLASS="COMMAND"
>iptables</B
>:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -d 172.16.3.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -o ppp0 -s 172.16.3.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -d 172.16.4.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -o ppp0 -s 172.16.4.0/24</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>La primera mitad de cada una de estas reglas dice, &ldquo;Cuente todos
los datos viajando en cualquier dirección por la interfaz llamada ppp0
con una dirección origen o destino (recuerde la función de la bandera
<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>-b</I
></SPAN
> en <B
CLASS="COMMAND"
>ipfwadm</B
> e <B
CLASS="COMMAND"
>iptables</B
>) 
de <TT
CLASS="LITERAL"
>172.16.3.0/24.</TT
>&rdquo; La segunda mitad de cada
conjunto de reglas es la misma, pero para la segunda red Ethernet en
nuestro sitio.</P
><P
>Para responder a la segunda pregunta , &ldquo;¿ Cuántos datos viajan entre
los dos departamentos ?&rdquo;, necesitamos una regla como esta:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -S 172.16.3.0/24 -D 172.16.4.0/24 -b</B
></TT
></PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -s 172.16.3.0/24 -d 172.16.4.0/24 -b</B
></TT
></PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -s 172.16.3.0/24 -d 172.16.4.0/24</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -s 172.16.4.0/24 -d 172.16.3.0/24</B
></TT
></PRE
></TD
></TR
></TABLE
>

Estas reglas contarán todos los datagramas con una dirección origen perteneciente
a una de las redes de departamento y una dirección destino perteneciente a la otra.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="X-087-2-ACCOUNTING.BY.SERVICE">10.2.2. Contabilidad por el Puerto de Servicio</H2
><P
>&#13;Bien, supongamos que también queremos una mejor idea de qué tipo de tráfico
exactamente está transportándose por nuestro enlace PPP. Por ejemplo, nosotros podríamos
querer saber cuánto del enlace están consumiendo los servicios FTP, SMTP, y Web.</P
><P
>Un guión de reglas para permitirnos coleccionar esta información podría parecerse a:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    #!/bin/sh
    # Coleccionar estadísticas de volumen FTP, SMTP y WWW para los datos
    # transportados en nuestro enlace PPP utilizando ipfwadm
    #
    ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 ftp ftp-data
    ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 smtp
    ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 www</PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    #!/bin/sh
    # Coleccionar estadísticas de volumen FTP, SMTP y WWW para los datos
    # transportados en nuestro enlace PPP utilizando ipchains
    #
    ipchains -A input -i ppp0 -p tcp -s 0/0 ftp-data:ftp
    ipchains -A output -i ppp0 -p tcp -d 0/0 ftp-data:ftp
    ipchains -A input -i ppp0 -p tcp -s 0/0 smtp
    ipchains -A output -i ppp0 -p tcp -d 0/0 smtp
    ipchains -A input -i ppp0 -p tcp -s 0/0 www
    ipchains -A output -i ppp0 -p tcp -d 0/0 www</PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    #!/bin/sh
    # Coleccionar estadísticas de volumen FTP, SMTP y WWW para los datos
    # transportados en nuestro enlace PPP utilizando iptables
    #
    iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport ftp-data:ftp
    iptables -A FORWARD -o ppp0 -m tcp -p tcp --dport ftp-data:ftp
    iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport smtp
    iptables -A FORWARD -o ppp0 -m tcp -p tcp --dport smtp
    iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport www
    iptables -A FORWARD -o ppp0 -m tcp -p tcp --dport www</PRE
></TD
></TR
></TABLE
></P
><P
>Hay un par de rasgos interesantes a esta configuración. Primeramente,
hemos especificado el protocolo. Cuando especificamos puertos en nuestras reglas,
también debemos especificar un protocolo porque TCP y UDP proveen conjuntos
separados de puertos. Ya que todos estos servicios están basados en TCP,
lo hemos especificado como el protocolo.  Segundo, tenemos especificado dos
servicios <TT
CLASS="LITERAL"
>ftp</TT
> y <TT
CLASS="LITERAL"
>ftp-data</TT
> en un comando.
<B
CLASS="COMMAND"
>ipfwadm</B
> permite establecer puertos simples, rango de puertos o
una lista arbitraria de puertos. La orden <B
CLASS="COMMAND"
>ipchains</B
> permite
cualesquiera, puertos simples o rango de puertos, que es lo que hemos usado aquí.
La sintaxis &ldquo;<TT
CLASS="LITERAL"
>ftp-data:ftp</TT
>&rdquo; significa &ldquo;puertos ftp-data (20) hasta
ftp (21),&rdquo; y es como nosotros codificamos rangos de puertos en ambos:
<B
CLASS="COMMAND"
>ipchains</B
> e <B
CLASS="COMMAND"
>iptables</B
>. Cuando usted tiene una
lista de puertos en una regla de contabilidad, eso significa que cualquier dato
recibido para alguno de los puertos en la lista, provocará que el dato sea sumado
a los totales de esa entrada. Recordando que el servicio FTP utiliza dos puertos,
el de órdenes y el de transferencia de datos, los hemos añadido a la vez para sumar
el tráfico de FTP. Finalmente, especificamos la dirección origen como &ldquo;<TT
CLASS="LITERAL"
>0/0</TT
>&rdquo;,
que es la notación especial que coincide con todas las direcciones y es requerida
por ambas órdenes <B
CLASS="COMMAND"
>ipfwadm</B
> e <B
CLASS="COMMAND"
>ipchains</B
>
para especificar los puertos.</P
><P
>Podemos extendernos un poco en el segundo punto para darnos una vista diferente  
de los datos en nuestro enlace. Ahora imaginemos que nosotros clasificamos tráfico
FTP, SMTP, y  del Web como tráfico esencial, y todo el otro tráfico
como no esencial. Si nosotros estuviéramos interesados en ver la proporción del
tráfico esencial al tráfico no esencial, podríamos hacer algo como:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 ftp ftp-data smtp www</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 1:19 22:24 26:79 81:32767</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>Si ya ha examinado su fichero <TT
CLASS="FILENAME"
>/etc/services</TT
>, observará que 
la segunda regla cubre todos los puertos excepto (<TT
CLASS="LITERAL"
>ftp</TT
>, <TT
CLASS="LITERAL"
>ftp-data</TT
>, <TT
CLASS="LITERAL"
>smtp</TT
>,
y <TT
CLASS="LITERAL"
>www</TT
>).</P
><P
>¿Cómo hacemos esto con las órdenes <B
CLASS="COMMAND"
>ipchains</B
> o
<B
CLASS="COMMAND"
>iptables</B
>, puesto que ellas permiten sólo un argumento en
la especificación de puerto ?. Podemos aprovecharnos en contabilidad, de las
cadenas definidas por usuario tan fácil como en las reglas del cortafuegos.
Considere el siguiente acercamiento:</P
><P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -N a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -N a-noness</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A a-essent -j ACCEPT</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A a-noness -j ACCEPT</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p tcp -s 0/0 ftp-data:ftp -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p tcp -s 0/0 smtp -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p tcp -s 0/0 www -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -j a-noness</B
></TT
></PRE
></TD
></TR
></TABLE
>

Aquí creamos dos cadenas definidas por usuario, una llamada 
<TT
CLASS="LITERAL"
>a-essent</TT
>, donde capturamos datos de contabilidad
para servicios esenciales y otra llamada <TT
CLASS="LITERAL"
>a-noness</TT
>,
donde capturamos datos de contabilidad para servicios no esenciales.
Entonces agregamos a nuestra cadena <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>forward</I
></SPAN
> las
reglas que coinciden con nuestros servicios esenciales y saltan a la cadena
<TT
CLASS="LITERAL"
>a-essent</TT
>, donde tenemos justamente una regla que
acepta todos los datagramas y los cuenta. La última regla en nuestra
cadena <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>forward</I
></SPAN
> es una regla que salta a nuestra
cadena <TT
CLASS="LITERAL"
>a-noness</TT
>, donde otra vez tenemos solamente
una regla que acepta todos los datagramas y los cuenta. La regla que
salta a la cadena <TT
CLASS="LITERAL"
>a-noness</TT
> no será alcanzada por
ninguno de nuestros servicios esenciales, puesto que ellos se habrán
aceptado en su propia cadena. Nuestras cuentas para servicios esenciales
y no esenciales estarán por consiguiente disponibles en las reglas
dentro de esas cadenas. Éste es simplemente un acercamiento que podría
tomar; hay otros. Nuestra implementación <B
CLASS="COMMAND"
>iptables</B
>
del mismo acercamiento se parecería a:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -N a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -N a-noness</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A a-essent -j ACCEPT</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A a-noness -j ACCEPT</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport ftp-data:ftp -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport smtp -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m tcp -p tcp --sport www -j a-essent</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -j a-noness</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>&#13;
Esto parece bastante simple. Desafortunadamente, hay un pequeño pero
inevitable problema al intentar efectuar contabilidad por el tipo de servicio.
Recordará que discutimos el rol que desempeña la MTU en redes TCP/IP en un capítulo anterior.
La MTU define el datagrama más largo que se transmitirá en un dispositivo de red.
Cuando un datagrama se recibe por un encaminador que es más grande que el MTU
de la interfaz que necesita al retransmitirlo, el encaminador realiza un truco
llamado <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>fragmentación</I
></SPAN
>. El encaminador fragmenta el datagrama
largo en piezas pequeñas no más largos que la MTU de la interfaz y entonces
transmite éstas piezas. El encaminador construye nuevas cabeceras para poner
delante de cada una de estas piezas, y éstas son las que la máquina remota
usa para reconstruir el dato original. Desafortunadamente, durante el proceso
de fragmentación el puerto se pierde para todos menos para el primer fragmento.
Esto significa que la contabilidad IP no puede contar adecuadamente datagramas
fragmentados. Puede contar fiablemente sólo el primer fragmento o datagramas 
no fragmentados. Hay un pequeño truco permitido por <B
CLASS="COMMAND"
>ipfwadm</B
> 
que asegura que mientras nosotros no podamos saber exactamente desde qué puerto 
el segundo y siguientes fragmentos vienen, podemos todavía contarlos. Una temprana
versión del software de contabilidad Linux asignó a los fragmentos un número de
puerto falso, 0xFFFF, que podríamos contar. Para asegurarnos que capturamos
el segundo y posteriores fragmentos, podemos usar una regla como ésta:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P tcp -S 0/0 0xFFFF</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>La implementación de cadenas IP tiene una solución ligeramente más sofisticada,
pero el resultado es muy similar. Usando la orden <B
CLASS="COMMAND"
>ipchains</B
>
usaríamos en cambio:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p tcp -f</B
></TT
></PRE
></TD
></TR
></TABLE
>

y con <B
CLASS="COMMAND"
>iptables</B
> usaríamos:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m tcp -p tcp -f</B
></TT
></PRE
></TD
></TR
></TABLE
></P
><P
>Éstos no nos dirán el puerto original para estos datos, pero por lo menos podemos ver cuanto
de nuestros datos son fragmentos, y seremos capaces de contabilizar el volumen de tráfico
que ellos consumen.</P
><P
>En núcleos 2.2 podemos seleccionar una opción del núcleo en tiempo de compilación, que 
niega este problema completo si su máquina GNU/Linux está actuando como el único punto de
acceso para una red. Si habilita la opción <TT
CLASS="OPTION"
>IP: Desfragmentar siempre</TT
>
cuando compila su núcleo, todos los datagramas recibidos serán reensamblados por el
encaminador Linux antes de encaminar y retransmitir. Esta operación es realizada antes
que el software de contabilidad y cortafuegos miren el datagrama, y así no tendrá
trato con ningún fragmento. En núcleos 2.4 usted puede compilar y cargar el módulo
<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>netfilter</I
></SPAN
> <TT
CLASS="FILENAME"
>forward-fragment</TT
>.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="X-087-2-ACCOUNTING.OF.ICMP">10.2.3. Contabilidad de Datagramas ICMP</H2
><P
>&#13;

El protocolo ICMP no usa número de puerto de servicio y es por eso un poco
más dificultoso coleccionar detalles. ICMP usa un número de tipos diferentes
de datagramas. Muchos de éstos son inofensivos y normales, mientras otros
sólo deben observarse bajo circunstancias especiales. A veces las personas
con mucho tiempo en sus manos intentan maliciosamente deteriorar el acceso
de un usuario a la red, generando grandes cantidades de mensajes ICMP. Esto
es comúnmente denominado <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>saturamiento ping</I
></SPAN
><A
NAME="AEN9570"
HREF="#FTN.AEN9570"
>[2]</A
>.
Aun cuando la contabilidad IP no puede hacer nada para prevenir este problema
( ¡ Aunque el cortafuegos IP puede ayudar ! ) podemos al menos colocar reglas
de contabilidad en un lugar que nos muestre si alguien lo ha estado intentando.</P
><P
>ICMP no usa los puertos como lo hacen TCP y UDP. En cambio ICMP tiene mensajes
tipo ICMP. Podemos construir reglas de contabilidad para cada tipo de mensaje
ICMP. Para hacer esto, colocamos el mensaje ICMP y el número del tipo en lugar
del puerto en la orden de contabilidad <B
CLASS="COMMAND"
>ipfwadm</B
>. Listamos
los tipos de mensaje ICMP en &ldquo;<A
HREF="x-087-2-firewall.original.html#X-087-2-FIREWALL.IPFWADM.ICMP-TYPES"
>Sección 9.6.3.5</A
>&rdquo;
refíerase a él si usted necesita recordar cuáles son.</P
><P
>Una regla de contabilidad IP para coleccionar información sobre el volumen
de datos ping que está enviándose a usted o que usted está generando podría
verse como:
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -P icmp -S 0/0 8</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -P icmp -S 0/0 0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -P icmp -S 0/0 0xff</B
></TT
></PRE
></TD
></TR
></TABLE
>

o, con <B
CLASS="COMMAND"
>ipchains</B
>:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -p icmp -s 0/0 8</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -p icmp -s 0/0 0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -p icmp -s 0/0 -f</B
></TT
></PRE
></TD
></TR
></TABLE
>

o, con <B
CLASS="COMMAND"
>iptables</B
>:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -m icmp -p icmp --sports echo-request</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -m icmp -p icmp --sports echo-reply</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -m icmp -p icmp -f</B
></TT
></PRE
></TD
></TR
></TABLE
>

La primera regla colecciona información sobre datagramas &ldquo;Petición de eco ICMP&rdquo;
(petición ping) <A
NAME="AEN9591"
HREF="#FTN.AEN9591"
>[3]</A
>,
y la segunda regla colecciona información sobre datagramas &ldquo;Respuesta de eco ICMP&rdquo;
(respuesta ping). La tercera regla colecciona información sobre fragmentos de datagrama ICMP.
Este es un truco similar al descrito para fragmentos de datagramas TCP y UDP.</P
><P
>Si usted especifica la dirección origen y/o destino en sus reglas, puede
seguir la pista de dónde están viniendo los ping, tales como si ellos se
originan dentro o fuera de su red. Una vez que ha determinado de dónde
están viniendo los datagramas pillos, usted puede decidir si quiere poner
reglas de cortafuegos en un sitio para evitarlos o tomar alguna otra
acción, como avisar al dueño de la red agraviante para avisarles del
problema, o quizás incluso, acción legal si el problema es un acto
malévolo.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="X-087-2-ACCOUNTING.BY.PROTOCOL">10.2.4. Contabilidad por Protocolo</H2
><P
>&#13;Imaginemos ahora que estamos interesados en conocer cuánto tráfico
en nuestro enlaces es TCP, UDP, e ICMP. Usaríamos reglas como las siguientes:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P tcp -D 0/0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P udp -D 0/0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipfwadm -A both -a -W ppp0 -P icmp -D 0/0</B
></TT
></PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p tcp -d 0/0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p udp -d 0/0</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>ipchains -A forward -i ppp0 -p icmp -d 0/0</B
></TT
></PRE
></TD
></TR
></TABLE
>

o:

<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m tcp -p tcp</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -o ppp0 -m tcp -p tcp</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m udp -p udp</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -o ppp0 -m udp -p udp</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -i ppp0 -m icmp -p icmp</B
></TT
>
    # <TT
CLASS="USERINPUT"
><B
>iptables -A FORWARD -o ppp0 -m icmp -p icmp</B
></TT
></PRE
></TD
></TR
></TABLE
>

Con estas reglas situadas, todo el tráfico fluyendo por la interfaz
<TT
CLASS="LITERAL"
>ppp0</TT
> será analizado para determinar si es TCP,
UDP, o tráfico de IMCP y los contadores apropiados serán actualizados
para cada uno. El ejemplo con <B
CLASS="COMMAND"
>iptables</B
> divide
el flujo entrante del flujo saliente como lo exige su sintaxis.</P
></DIV
></DIV
><H3
CLASS="FOOTNOTES"
>Notas</H3
><TABLE
BORDER="0"
CLASS="FOOTNOTES"
WIDTH="100%"
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN9409"
HREF="x-087-2-accounting.ipfwadm.html#AEN9409"
>[1]</A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Traducción de IP Chains Firewall. N. del T.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN9570"
HREF="x-087-2-accounting.ipfwadm.html#AEN9570"
>[2]</A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Traducción de <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>ping flooding</I
></SPAN
> N. del T.</P
></TD
></TR
><TR
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="5%"
><A
NAME="FTN.AEN9591"
HREF="x-087-2-accounting.ipfwadm.html#AEN9591"
>[3]</A
></TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
WIDTH="95%"
><P
>Traducción de ICMP Echo Request. N. del T.</P
></TD
></TR
></TABLE
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x-087-2-accounting.kernel.config.html"
ACCESSKEY="P"
>Anterior</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Inicio</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="x-087-2-accounting.viewing.results.html"
ACCESSKEY="N"
>Siguiente</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Configurando el núcleo para contabilidad IP</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="x-087-2-accounting.html"
ACCESSKEY="U"
>Subir</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Utilizando los resultados de contabilidad IP</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>